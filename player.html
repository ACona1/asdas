<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<<<<<<< HEAD
  <title>Fsh5Flix — المشغل (مودرن)</title>
  <style>
    :root{
      --bg-1: #030409; --bg-2:#071422; --accent:#e50914; --muted:rgba(255,255,255,0.65);
      --card-w: 320px; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#eaf6ff}

    /* layout container */
    .container{width:94%;max-width:1200px;margin:28px auto;padding:18px}
    .top{display:flex;gap:22px;align-items:flex-start}

    /* poster card (smaller & modern) */
    .poster-card{width:var(--card-w);min-width:220px;border-radius:var(--radius);overflow:hidden;position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 18px 60px rgba(1,8,20,0.7);border:1px solid rgba(255,255,255,0.03)}
    .poster-inner{position:relative;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;flex-direction:column;gap:12px;height:100%}
    .poster-thumb{width:100%;height:440px;border-radius:10px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    .poster-thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .5s cubic-bezier(.2,.9,.3,1)}
    .poster-meta{display:flex;flex-direction:column;gap:6px}
    .poster-title{font-weight:800;font-size:16px}
    .poster-actions{display:flex;flex-direction:column;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* main player area */
    .player-area{flex:1;display:flex;flex-direction:column;gap:16px}
    .video-frame{position:relative;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 30px 90px rgba(0,0,0,0.7)}
    video{width:100%;height:auto;display:block;max-height:72vh;object-fit:contain;background:#000}

    /* overlay play button (centered, but small since poster card is smaller) */
    .poster-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:12px;background:linear-gradient(180deg,rgba(0,0,0,0.15),rgba(0,0,0,0.25));z-index:6;cursor:pointer;transition:opacity .5s}
    .poster-overlay .play{width:88px;height:88px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;background:linear-gradient(135deg,rgba(229,9,20,0.95),rgba(229,9,20,0.78));box-shadow:0 18px 40px rgba(229,9,20,0.12);transform:translateY(0);transition:transform .22s}
    .poster-overlay:hover .play{transform:translateY(-6px) scale(1.04)}
    .poster-overlay.fade-out{opacity:0;pointer-events:none}

    /* episodes buttons bigger and clear */
    .episodes{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .ep{padding:10px 14px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;font-weight:800;color:#eaf6ff;transition:all .12s}
    .ep:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.45)}
    .ep.active{background:linear-gradient(90deg,rgba(229,9,20,0.14),rgba(229,9,20,0.06));border-color:rgba(229,9,20,0.28)}

    /* subtle responsive */
    @media (max-width:980px){
      .top{flex-direction:column}
      .poster-card{width:100%;display:flex}
      .poster-thumb{height:320px}
    }

    /* small helper */
    .note{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="poster-card" id="posterCard">
        <div class="poster-inner">
          <div class="poster-thumb" id="posterThumb">
            <img id="posterImg" src="" alt="poster">
            <div class="poster-overlay" id="posterOverlay"><div class="play">▶</div></div>
          </div>
          <div class="poster-meta">
            <div class="poster-title" id="titleEl"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="poster-actions">
                <button class="btn" id="pipBtn">PIP</button>
                <a id="downloadBtn" class="btn ghost" download>تحميل</a>
              </div>
              <div class="note">اضغط على البوستر للبدء</div>
            </div>
          </div>
        </div>
      </div>

      <div class="player-area">
        <div class="video-frame" id="videoFrame">
          <video id="video" controls playsinline crossorigin="anonymous"></video>
        </div>
        <div class="episodes" id="episodes"></div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const folderRaw = params.get('folder') || '';
    const folderEnc = encodeURIComponent(folderRaw);
    const startIdx = parseInt(params.get('idx')||'0',10);

    const posterImg = document.getElementById('posterImg');
    const posterOverlay = document.getElementById('posterOverlay');
    const posterThumb = document.getElementById('posterThumb');
    const titleEl = document.getElementById('titleEl');
    const videoEl = document.getElementById('video');
    const episodesEl = document.getElementById('episodes');
    const downloadBtn = document.getElementById('downloadBtn');
    const pipBtn = document.getElementById('pipBtn');

    const JSON_IN_FOLDER = `${folderEnc}/playlist.json`;
    const POSTER_IN_FOLDER = `${folderEnc}/poster.jpg`;

    async function tryHead(url){
      try{ const r = await fetch(url, {method:'HEAD'}); return r.ok; }catch(e){ return false; }
    }

    async function loadFolder(){
      try{
        if(!folderRaw) throw new Error('اسم الفولدر مش محدد');
        const r = await fetch(JSON_IN_FOLDER);
        if(!r.ok) throw new Error('مش لاقي ' + JSON_IN_FOLDER);
        const json = await r.json();

        let items = [];
        if(Array.isArray(json)) items = json;
        else if(json && typeof json === 'object'){
          if(json[folderRaw]) items = json[folderRaw];
          else {
            const keys = Object.keys(json);
            for(const k of keys){ if(Array.isArray(json[k])){ items = json[k]; break; } }
          }
        }
        if(!Array.isArray(items) || items.length === 0) throw new Error('مفيش فيديوهات فـ '+ JSON_IN_FOLDER);

        // set title
        titleEl.textContent = folderRaw || '';

        // poster
        const posterExists = await tryHead(POSTER_IN_FOLDER);
        if(posterExists) posterImg.src = POSTER_IN_FOLDER; else posterImg.src = '';

        // normalize items
        const normalized = items.map(it => ({ video: typeof it === 'string' ? it : (it.video||it.src), subtitle: it.subtitle||it.sub||it.vtt||null }));

        // build episodes UI
        episodesEl.innerHTML = '';
        normalized.forEach((it,i)=>{
          const b = document.createElement('div'); b.className='ep'; b.textContent = normalized.length>1?('E'+String(i+1).padStart(2,'0')):'فيلم';
          b.addEventListener('click', ()=> playIndex(i));
          episodesEl.appendChild(b);
        });

        // download default
        downloadBtn.href = normalized[startIdx].video || '#';

        // poster overlay click to play
        posterOverlay.addEventListener('click', ()=>{ posterOverlay.classList.add('fade-out'); setTimeout(()=>{ posterOverlay.style.display='none'; },500); playIndex(currentIndex); });

        // subtitle finder
        async function findSubtitle(i){
          const it = normalized[i];
          if(it.subtitle){ const cand = it.subtitle.includes('/')? it.subtitle : `${folderEnc}/${it.subtitle}`; if(await tryHead(cand)) return cand; }
          const ep = String(i+1).padStart(2,'0');
          const guesses = [ `${folderEnc}/E${ep}.vtt`, `${folderEnc}/e${ep}.vtt`, `${folderRaw}/E${ep}.vtt`, `${folderRaw}/E${i+1}.vtt` ];
          for(const g of guesses) if(await tryHead(g)) return g;
          return null;
        }

        // play logic
        let currentIndex = startIdx;
        async function playIndex(i){
          currentIndex = i;
          const it = normalized[i];
          if(!it||!it.video){ alert('رابط الفيديو غير متاح'); return; }
          videoEl.src = it.video;
          downloadBtn.href = it.video || '#';

          // remove old tracks
          const tks = videoEl.querySelectorAll('track'); tks.forEach(t=>t.remove());
          const sub = await findSubtitle(i);
          if(sub){ const tr = document.createElement('track'); tr.kind='subtitles'; tr.src=sub; tr.srclang='ar'; tr.label='العربية'; tr.default=true; videoEl.appendChild(tr); }

          try{ await videoEl.play(); }catch(e){}
          document.querySelectorAll('.ep').forEach((n,idx)=> n.classList.toggle('active', idx===i));
        }

        // highlight default
        document.querySelectorAll('.ep').forEach((n, idx)=> n.classList.toggle('active', idx===currentIndex));

        // pip
        pipBtn.addEventListener('click', async ()=>{ try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await videoEl.requestPictureInPicture(); }catch(e){ alert('PIP غير مدعوم'); } });

        // save resume
        const posKey = 'fsh5flix_pos_' + encodeURIComponent(folderRaw);
        videoEl.addEventListener('timeupdate', ()=>{ try{ localStorage.setItem(posKey, Math.floor(videoEl.currentTime)); }catch(e){} });
        const saved = parseInt(localStorage.getItem(posKey)||'0',10);
        if(saved>0){ videoEl.addEventListener('play', function handler(){ if(videoEl.currentTime<1) videoEl.currentTime = saved; videoEl.removeEventListener('play', handler); }); }

        window.playIndex = playIndex;
      }catch(err){ console.error(err); alert('حصل خطأ: ' + (err.message||err)); }
    }

    let currentItems = [];
    loadFolder();
=======
  <title>Fsh5Flix — المشغل (مُحدَّث)</title>
  <link href="https://vjs.zencdn.net/8.20.0/video-js.css" rel="stylesheet" />
  <style>
    :root{--bg:#000;--accent:#e50914;--muted:rgba(255,255,255,0.6)}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#000,#041021);font-family:Inter,system-ui,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    .top{display:flex;gap:20px;align-items:flex-start}
    .poster{width:380px;min-width:180px;border-radius:12px;overflow:hidden;box-shadow:0 30px 90px rgba(0,0,0,0.7)}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .info{flex:1}
    .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .player-wrap{margin-top:18px}
    .video-js{width:100%;height:56vw;max-height:72vh;border-radius:12px;background:#000}
    .episodes{margin-top:18px;display:flex;flex-wrap:wrap;gap:12px}
    .ep{padding:12px 18px;border-radius:14px;background:rgba(255,255,255,0.03);cursor:pointer;font-weight:900;font-size:15px;color:#e6f2f8;border:1px solid rgba(255,255,255,0.03);transition:transform .14s ease,box-shadow .14s}
    .ep:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(0,0,0,0.45)}
    .ep.active{background:linear-gradient(90deg,rgba(229,9,20,0.18),rgba(229,9,20,0.06));border-color:rgba(229,9,20,0.28);color:#fff}
    .bottom-note{color:var(--muted);margin-top:10px;font-size:13px}
    @media (max-width:900px){.top{flex-direction:column}.poster{width:100%}.btn{padding:8px 10px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="poster" id="posterBox"><img id="posterImg" src="" alt="poster"/></div>
      <div class="info">
        <div class="controls-row">
          <button class="btn" id="togglePip">PIP</button>
          <a id="downloadBtn" class="btn ghost" href="#" download>تحميل</a>
          <button class="btn ghost" id="toggleSub">ترجمات</button>
          <button class="btn ghost" id="theater">Theater</button>
        </div>
      </div>
    </div>

    <div class="player-wrap">
      <video id="vjs-player" class="video-js vjs-big-play-centered" controls preload="auto" playsinline></video>
    </div>

    <div class="episodes" id="episodes"></div>
    <div class="bottom-note">النظام يقرأ JSON بصيغتين: القديم (مصفوفة) أو الجديد (كائن فيه poster و videos).</div>
  </div>

  <script src="https://vjs.zencdn.net/8.20.0/video.min.js"></script>
  <script>
    // READ URL PARAMS
    const qs = new URLSearchParams(window.location.search);
    const titleParam = qs.get('title');
    const startIdx = parseInt(qs.get('idx')||'0',10);

    const JSON_URL = '/playlist.json';
    const posterImg = document.getElementById('posterImg');
    const episodesEl = document.getElementById('episodes');
    const downloadBtn = document.getElementById('downloadBtn');
    const toggleSubBtn = document.getElementById('toggleSub');
    const pipBtn = document.getElementById('togglePip');
    const theaterBtn = document.getElementById('theater');

    const player = videojs('vjs-player', {controls:true,fluid:true,playbackRates:[0.5,1,1.25,1.5,2]});

    // helper: normalize an item to have {video, subtitle}
    function normalizeItem(it){
      if(!it) return null;
      if(typeof it === 'string') return {video: it};
      return {
        video: it.video || it.src || null,
        subtitle: it.subtitle || it.sub || it.vtt || null,
        poster: it.poster || null
      };
    }

    // fetch playlist and initialize
    async function load(){
      try{
        const res = await fetch(JSON_URL);
        if(!res.ok) throw new Error('فشل تحميل JSON');
        const data = await res.json();

        const keys = Object.keys(data || {});
        if(keys.length === 0) throw new Error('playlist.json فاضي');

        let chosenTitle = titleParam || keys[0];
        if(!data[chosenTitle]) chosenTitle = keys[0];

        const raw = data[chosenTitle];
        let poster = '';
        let items = [];

        // two supported shapes:
        // 1) old: "Title": [ {video:..., sub:...}, ... ]
        // 2) new: "Title": { poster: 'Title/poster.jpg', videos: [ {video:..., subtitle:...}, ... ] }

        if(Array.isArray(raw)){
          items = raw.map(normalizeItem).filter(Boolean);
          poster = (raw[0] && raw[0].poster) ? raw[0].poster : '';
        } else if(raw && typeof raw === 'object'){
          if(Array.isArray(raw.videos)){
            items = raw.videos.map(normalizeItem).filter(Boolean);
          } else if(raw.video){
            // edge: single object
            items = [normalizeItem(raw)];
          }
          poster = raw.poster || '';
        }

        // ensure items is array
        if(!Array.isArray(items)) items = [];
        if(items.length === 0) throw new Error('لا توجد فيديوهات متاحة لهذا العنوان');

        setupPlayer(chosenTitle, poster, items, startIdx);
      }catch(err){
        alert('حصل خطأ: '+err.message);
        console.error(err);
      }
    }

    function clearRemoteTracks(){
      const rtt = player.remoteTextTracks();
      for(let j=rtt.length-1;j>=0;j--){ try{ player.removeRemoteTextTrack(rtt[j]); }catch(e){} }
    }

    async function tryHead(url){
      try{
        const res = await fetch(url, {method:'HEAD'});
        return res.ok;
      }catch(e){ return false; }
    }

    // guesses for subtitle paths (still try server HEAD)
    function subtitleGuesses(title, idx){
      const enc = encodeURIComponent(title);
      const ep = (idx+1).toString().padStart(2,'0');
      return [
        `${enc}/E${ep}.vtt`, `${enc}/e${ep}.vtt`, `${enc}/E${idx+1}.vtt`,
        `${title}/E${ep}.vtt`, `${title}/E${idx+1}.vtt`, `${enc}/${enc}.vtt`, `${title}/${title}.vtt`
      ];
    }

    // guesses for poster paths
    function posterGuesses(title){
      const enc = encodeURIComponent(title);
      return [`${enc}/poster.jpg`, `${enc}/poster.png`, `${title}/poster.jpg`, `${title}/poster.png`, `poster.jpg`];
    }

    async function findSubtitle(title, idx, item){
      if(item && item.subtitle){
        // if provided and looks absolute or relative
        try{ const ok = await tryHead(item.subtitle); if(ok) return item.subtitle; }catch(e){}
      }
      const guesses = subtitleGuesses(title, idx);
      for(const g of guesses){ if(await tryHead(g)) return g; }
      return null;
    }

    async function findPoster(title, providedPoster, items, idx){
      if(providedPoster){ try{ if(await tryHead(providedPoster)) return providedPoster; }catch(e){} }
      // check per-item poster
      if(items[idx] && items[idx].poster){ try{ if(await tryHead(items[idx].poster)) return items[idx].poster; }catch(e){} }
      const guesses = posterGuesses(title);
      for(const g of guesses){ if(await tryHead(g)) return g; }
      return null;
    }

    function highlightEpisode(i){
      const nodes = episodesEl.querySelectorAll('.ep'); nodes.forEach(n=>n.classList.remove('active')); if(nodes[i]) nodes[i].classList.add('active');
    }

    function savePositionKey(title){ return 'fsh5flix_pos_'+encodeURIComponent(title); }

    function playIndexFactory(title, items){
      return async function playIndex(i){
        const it = items[i];
        if(!it || !it.video){ alert('رابط الفيديو غير متاح'); return; }
        player.pause();
        player.src({src: it.video, type: 'video/mp4'});
        clearRemoteTracks();

        const subUrl = await findSubtitle(title, i, it);
        if(subUrl){ try{ player.addRemoteTextTrack({kind:'subtitles',src:subUrl, srclang:'ar',label:'العربية',default:true}, false); }catch(e){ console.warn(e); } }

        downloadBtn.href = it.video || '#';
        highlightEpisode(i);
        player.ready(()=>{ player.play().catch(()=>{}); });

        // resume per title
        const key = savePositionKey(title);
        const saved = parseInt(localStorage.getItem(key)||'0',10);
        if(saved>0){
          player.on('play', function handler(){ if(player.currentTime()<1 && saved>0){ player.currentTime(saved); } player.off('play', handler); });
        }

        player.off('timeupdate');
        player.on('timeupdate', ()=>{ try{ localStorage.setItem(key, Math.floor(player.currentTime())); }catch(e){} });
      }
    }

    async function setupPlayer(title, posterPath, items, idx){
      // poster
      const foundPoster = await findPoster(title, posterPath, items, idx);
      if(foundPoster) posterImg.src = foundPoster; else posterImg.src = '';

      // build episodes
      episodesEl.innerHTML = '';
      items.forEach((it,i)=>{
        const b = document.createElement('div'); b.className='ep'; b.textContent = items.length>1?('E'+(i+1).toString().padStart(2,'0')):'فيلم';
        b.addEventListener('click', ()=>{ playIndex(i); });
        episodesEl.appendChild(b);
      });

      const playIndex = playIndexFactory(title, items);
      playIndex(Math.max(0, Math.min(idx, items.length-1)));
      highlightEpisode(idx);

      // download button
      downloadBtn.href = items[idx].video || '#';

      // pip
      pipBtn.addEventListener('click', async ()=>{ try{ const v = document.querySelector('#vjs-player_html5_api'); if(v) await v.requestPictureInPicture(); }catch(e){ alert('PIP غير مدعوم'); } });

      // subtitles toggle
      toggleSubBtn.addEventListener('click', ()=>{ const tracks = player.textTracks(); if(tracks && tracks.length>0){ for(let i=0;i<tracks.length;i++){ tracks[i].mode = (tracks[i].mode==='showing')? 'disabled' : 'showing'; } } else alert('لا توجد ترجمات مضافة'); });

      theaterBtn.addEventListener('click', ()=>{ document.body.classList.toggle('theater'); });
    }

    // start
    load();

    // stop playback on unload
    window.addEventListener('beforeunload', ()=>{ try{ player.pause(); }catch(e){} });
>>>>>>> 6ceaa85b1c6b1569888e61ab6d0713258b67a5d7
  </script>
</body>
</html>
